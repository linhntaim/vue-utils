{"version":3,"sources":["../../src/file/files-uploader.js"],"names":["FilesUploader","ui","maxUploadFileSize","maximumChunkSize","percentageTextTemplate","files","progress","ProgressHandler","filteredCallback","chunkSize","everyChunkCallback","everyDoneCallback","everyErrorCallback","everyPromisedBeforeCallback","preview","processFiles","then","processChunks","processPreview","Promise","resolve","remaining","length","left","increaseLimit","Array","from","forEach","file","run","progressResolve","progressReject","waitRendering","push","original","reset","processFilePreview","doneCallback","errorCallback","reader","FileReader","onerror","onabort","onload","e","target","result","readAsDataURL","data","processFileChunks","chunkCallback","fileSplitter","FileSplitter","reject","every","chunkData","chunkIndex","chunksTotal"],"mappings":"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","sourcesContent":["import {ProgressHandler} from '../progress-handler'\r\nimport {FileSplitter} from './file-splitter'\r\n\r\nexport class FilesUploader {\r\n    constructor(ui, maxUploadFileSize, maximumChunkSize = 1024 * 1024 * 10, percentageTextTemplate = '{percent}%') {\r\n        this.ui = ui\r\n        this.maxUploadFileSize = maxUploadFileSize\r\n        this.maximumChunkSize = maximumChunkSize\r\n        this.percentageTextTemplate = percentageTextTemplate\r\n        this.files = []\r\n        this.progress = new ProgressHandler(this.ui, this.percentageTextTemplate)\r\n    }\r\n\r\n    quickProcessFilesWithChunks({files, filteredCallback = null}, {chunkSize, everyChunkCallback, everyDoneCallback = null, everyErrorCallback = null, everyPromisedBeforeCallback = null}, preview = false) {\r\n        this.processFiles(files, filteredCallback).then(() => {\r\n            const processChunks = () => this.processChunks(chunkSize, everyChunkCallback, everyDoneCallback, everyErrorCallback, everyPromisedBeforeCallback)\r\n            preview ? this.processPreview().then(processChunks) : processChunks()\r\n        })\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param {FileList | array } files\r\n     * @param {function | null} filteredCallback\r\n     * @return {Promise}\r\n     */\r\n    processFiles(files, filteredCallback = null) {\r\n        this.files = []\r\n        return new Promise(resolve => {\r\n            let remaining = files.length\r\n            const left = () => {\r\n                --remaining\r\n                if (remaining === 0) {\r\n                    resolve()\r\n                }\r\n            }\r\n\r\n            this.progress.increaseLimit(remaining)\r\n            Array.from(files).forEach(file => {\r\n                this.progress.run((progressResolve, progressReject) => {\r\n                    if (!filteredCallback || filteredCallback(file)) {\r\n                        this.ui.waitRendering(() => {\r\n                            this.files.push({\r\n                                original: file,\r\n                                progress: new ProgressHandler(this.ui, this.percentageTextTemplate),\r\n                                preview: null,\r\n                            })\r\n\r\n                            progressResolve()\r\n                            left()\r\n                        })\r\n                        return\r\n                    }\r\n\r\n                    progressReject()\r\n                    left()\r\n                })\r\n            })\r\n        })\r\n    }\r\n\r\n    length() {\r\n        return this.files.length\r\n    }\r\n\r\n    clear() {\r\n        this.files = []\r\n        this.progress.reset()\r\n    }\r\n\r\n    processPreview() {\r\n        return new Promise(resolve => {\r\n            let remaining = this.files.length\r\n            const left = () => {\r\n                --remaining\r\n                if (remaining === 0) {\r\n                    resolve()\r\n                }\r\n            }\r\n\r\n            this.progress.increaseLimit(remaining)\r\n            this.files.forEach(file => {\r\n                this.progress.run((progressResolve, progressReject) => {\r\n                    this.processFilePreview(file, () => {\r\n                        progressResolve()\r\n                        left()\r\n                    }, () => {\r\n                        progressReject()\r\n                        left()\r\n                    })\r\n                })\r\n            })\r\n        })\r\n    }\r\n\r\n    processFilePreview(file, doneCallback = null, errorCallback = null) {\r\n        const reader = new FileReader()\r\n        reader.onerror = () => {\r\n            errorCallback && errorCallback()\r\n        }\r\n        reader.onabort = () => {\r\n            errorCallback && errorCallback()\r\n        }\r\n        reader.onload = e => {\r\n            this.ui.waitRendering(() => {\r\n                file.preview = e.target.result\r\n\r\n                doneCallback && doneCallback()\r\n            })\r\n        }\r\n        this.ui.waitRendering(() => reader.readAsDataURL(file.original))\r\n\r\n        return this\r\n    }\r\n\r\n    processChunks(everyChunkCallback, everyDoneCallback = null, everyErrorCallback = null, everyPromisedBeforeCallback = null) {\r\n        let chunkSize = this.maxUploadFileSize / 2\r\n        if (chunkSize > this.maximumChunkSize) {\r\n            chunkSize = this.maximumChunkSize\r\n        }\r\n\r\n        return new Promise(resolve => {\r\n            let remaining = this.files.length\r\n            const left = () => {\r\n                --remaining\r\n                if (remaining === 0) {\r\n                    resolve()\r\n                }\r\n            }\r\n\r\n            this.progress.increaseLimit(remaining)\r\n            this.files.forEach(file => {\r\n                const run = (data = null) => {\r\n                    this.progress.run((progressResolve, progressReject) => {\r\n                        this.processFileChunks(file, chunkSize, everyChunkCallback, data).then(() => {\r\n                            progressResolve()\r\n                            everyDoneCallback && everyDoneCallback(file)\r\n                            left()\r\n                        }).catch(() => {\r\n                            progressReject()\r\n                            everyErrorCallback && everyErrorCallback(file)\r\n                            left()\r\n                        })\r\n                    })\r\n                }\r\n\r\n                (everyPromisedBeforeCallback && everyPromisedBeforeCallback(file).then(run).catch(left)) || run()\r\n            })\r\n        })\r\n    }\r\n\r\n    processFileChunks(file, chunkSize, chunkCallback, data = null) {\r\n        const fileSplitter = new FileSplitter(file.original, chunkSize)\r\n\r\n        return new Promise((resolve, reject) => {\r\n            let remaining = fileSplitter.length()\r\n            const left = () => {\r\n                --remaining\r\n                if (remaining === 0) {\r\n                    resolve()\r\n                }\r\n            }\r\n\r\n            file.progress.increaseLimit(remaining)\r\n            fileSplitter.every((chunkData, chunkIndex, chunksTotal) => {\r\n                file.progress.run((progressResolve, progressReject) => {\r\n                    this.ui.waitRendering(() => {\r\n                        chunkCallback(chunkData, chunkIndex, chunksTotal, () => {\r\n                            progressResolve()\r\n                            left()\r\n                        }, () => {\r\n                            progressReject()\r\n                            reject()\r\n                        }, file, data)\r\n                    })\r\n                })\r\n            })\r\n        })\r\n    }\r\n}"],"file":"files-uploader.js"}